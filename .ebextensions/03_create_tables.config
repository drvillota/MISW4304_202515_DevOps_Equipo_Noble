container_commands:
  01_migrate_db:
    command: |
      set -e
      echo "=== Creating tables if they do not exist ==="
      # Find Elastic Beanstalk virtualenv python dynamically
      VENV_PY="$(ls -1 /var/app/venv/*/bin/python 2>/dev/null | head -n1)"
      if [ -z "$VENV_PY" ]; then
        echo "No EB venv python found under /var/app/venv/*/bin/python; skipping DB migrate (non-fatal)."
        exit 0
      fi

      # Write a small Python script without using a here-doc (avoids YAML parsing issues)
      printf '%s\n' \
        'from application import db' \
        'try:' \
        '    db.create_all()' \
        "    print('Tables created successfully.')" \
        'except Exception as e:' \
        "    print('Error creating tables:', e)" \
        > create_tables.py

      # Run with the EB venv python; never fail deployment if migration hits a transient error
      "$VENV_PY" create_tables.py || true
    leader_only: true
